@model IEnumerable<TiendaWed.Models.Registrarse>

@{
    ViewData["Title"] = "Gestión de Usuarios";
}

<div class="container mt-5">
    <h2 class="text-center mb-4">Panel de Administración - Usuarios</h2>

    <!-- Mensajes -->
    @if (TempData["MensajeExito"] != null)
    {
        <div class="alert alert-success text-center">@TempData["MensajeExito"]</div>
    }
    @if (TempData["ErrorRegistro"] != null)
    {
        <div class="alert alert-danger text-center">@TempData["ErrorRegistro"]</div>
    }

    <!-- Barra de acciones -->
    <div class="d-flex justify-content-between mb-3">
        <!-- Botón para abrir modal -->
        <button class="btn btn-success" onclick="abrirModalAgregar()">
            <i class="bi bi-person-plus"></i> Agregar Usuario
        </button>
        <input type="text" id="buscar" class="form-control w-25" placeholder="Buscar...">
    </div>

    <!-- Tabla -->
    <div class="table-responsive shadow-lg">
        <table class="table table-striped table-hover text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Id</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios">
                @foreach (var u in Model)
                {
                    <tr>
                        <td>@u.Id</td>
                        <td>@u.Nombre</td>
                        <td>@u.Apellido</td>
                        <td>@u.Correo</td>
                        <td>@u.Telefono</td>
                        <td>
                            <span class="badge bg-@(u.Rol == Rol.Admin ? "danger" : "primary")">
                                @u.Rol
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-success">Activo</span>
                        </td>
                        <td>@u.FechaCreacion.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-warning btn-sm"
                                    onclick="abrirModalEditar(@u.Id, '@u.Nombre', '@u.Apellido', '@u.Correo', '@u.Telefono', '@u.Rol')">
                                Editar
                            </button>
                            <button class="btn btn-danger btn-sm"
                                    onclick="abrirModalEliminar(@u.Id, '@u.Nombre')">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Agregar -->
<div class="modal fade" id="modalAgregar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formAgregar" method="post">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Agregar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Nombre</label>
                        <input type="text" name="Nombre" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Apellido</label>
                        <input type="text" name="Apellido" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Correo</label>
                        <input type="email" name="Correo" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Teléfono</label>
                        <input type="text" name="Telefono" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Contraseña</label>
                        <input type="password" name="Contraseña" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Rol</label>
                        <select name="Rol" class="form-select">
                            <option value="Cliente" selected>Cliente</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditar" method="post">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editarId" name="Id" />
                    <div class="mb-3">
                        <label>Nombre</label>
                        <input type="text" id="editarNombre" name="Nombre" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Apellido</label>
                        <input type="text" id="editarApellido" name="Apellido" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Correo</label>
                        <input type="email" id="editarCorreo" name="Correo" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Teléfono</label>
                        <input type="text" id="editarTelefono" name="Telefono" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label>Rol</label>
                        <select id="editarRol" name="Rol" class="form-select">
                            <option value="Cliente">Cliente</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEliminar" method="post">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Eliminar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="eliminarId" name="Id" />
                    <p>¿Seguro que deseas eliminar al usuario <strong id="nombreUsuarioEliminar"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    function abrirModalEditar(id, nombre, apellido, correo, telefono, rol) {
        document.getElementById("editarId").value = id;
        document.getElementById("editarNombre").value = nombre;
        document.getElementById("editarApellido").value = apellido;
        document.getElementById("editarCorreo").value = correo;
        document.getElementById("editarTelefono").value = telefono;
        document.getElementById("editarRol").value = rol;

        document.getElementById("formEditar").action = "/Admin/EditarUsuario/" + id;
        new bootstrap.Modal(document.getElementById("modalEditar")).show();
    }

    function abrirModalEliminar(id, nombre) {
        document.getElementById("eliminarId").value = id;
        document.getElementById("nombreUsuarioEliminar").textContent = nombre;

        document.getElementById("formEliminar").action = "/Admin/EliminarUsuario/" + id;
        new bootstrap.Modal(document.getElementById("modalEliminar")).show();
    }

    // Buscar en tabla
    document.getElementById("buscar").addEventListener("keyup", function () {
        var filtro = this.value.toLowerCase();
        var filas = document.querySelectorAll("#tablaUsuarios tr");

        filas.forEach(function (fila) {
            var texto = fila.textContent.toLowerCase();
            fila.style.display = texto.includes(filtro) ? "" : "none";
        });
    });

    // Abrir modal agregar
    function abrirModalAgregar() {
        new bootstrap.Modal(document.getElementById("modalAgregar")).show();
    }

    // Acción del formulario agregar
    document.getElementById("formAgregar").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = this;
        const actionUrl = "/Admin/Registrase"; // Acción en tu controlador

        fetch(actionUrl, {
            method: "POST",
            body: new FormData(form)
        })
        .then(r => {
            if (r.ok) {
                location.reload();
            } else {
                alert("Error al agregar el usuario.");
            }
        })
        .catch(() => alert("Ocurrió un error al enviar la solicitud."));
    });
</script>
